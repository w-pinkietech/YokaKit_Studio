---
description: Run the Construction workflow for a given context/unit, producing Domain Design, Logical Design, test specifications, and mapping updates.
---

The user input to you can be provided directly by the agent or as a command argument - you **MUST** consider it before proceeding (if not empty).

User input:

$ARGUMENTS

## Purpose
- Translate approved Inception artifacts into executable Construction documentation.
- Generate Domain Design (static/dynamic), Logical Design (ADR), test specifications, and code mapping scaffolds.
- Ensure alignment with the project constitution (`.aidlc/constitution.md`) and any relevant ADRs.

## Expected Arguments
`/construction <context-id>/<unit-name>` or `/construction <unit-name>`

- If only `<unit-name>` is supplied, interactively ask the user to choose the target context.
- `<context-id>` must match a directory under `.aidlc/contexts/`.

## Pre-flight Checklist
1. Confirm the corresponding Inception artifacts exist:
   - `.aidlc/contexts/<ctx>/inception/intent.md`
   - `.aidlc/contexts/<ctx>/inception/units.md`
   - At least one `stories/story-*.md`
2. Review `.aidlc/constitution.md` and note technical or process constraints.
3. Check for existing Construction folder:
   - `.aidlc/contexts/<ctx>/construction/`
   - If present, decide with the user whether to extend or replace artifacts (create backups if instructed).

## Directory Layout
Create / ensure the following structure exists:
```
.aidlc/contexts/<ctx>/
└── construction/
    ├── domain-design/
    │   ├── static-model.md
    │   └── dynamic-model.md
    ├── logical-design/
    │   ├── adr/
    │   │   └── XXX-<slug>.md
    │   └── architecture.md
    ├── tests/
    │   └── specification.md
    └── code-mapping.md
```

## Artifact Requirements

### domain-design/static-model.md
```
# Static Model — <Unit Name>

## Entities
- <EntityName>
  - **Responsibilities**: ...
  - **Attributes**: ...
  - **Relationships**: ...

## Value Objects
- <VOName>
  - **Responsibilities**: ...
  - **Attributes**: ...

## Services
- <ServiceName>
  - **Responsibilities**: ...
  - **Collaborators**: ...

## Repositories
- <RepositoryName>
  - **Responsibilities**: ...

## Aggregates / Modules
- <AggregateName>
  - **Includes**: <entity list>
```

### domain-design/dynamic-model.md
Include one sequence (or activity) diagram per key story plus narrative text.
```
# Dynamic Models — <Unit Name>

## <Story Title>
```mermaid
sequenceDiagram
    Actor ->> Component: action()
    Component ->> Service: collaborate()
```

### logical-design/architecture.md
Summarise the technical approach, interfaces, external systems, and constraints. Reference existing ADRs where applicable.

### logical-design/adr/XXX-<slug>.md
Create at least one ADR per critical decision. Follow standard ADR structure:
```
# ADR-XXX: <Title>
Date: YYYY-MM-DD
Status: Proposed | Accepted | Superseded
Context:
Decision:
Consequences:
Alternatives Considered:
```
Increment ADR numbers sequentially within the context.

### tests/specification.md
```
# Test Specification — <Unit Name>

## Scope
- <summary>

## Test Cases
| ID | Story | Type | Description | Expected Result |
|----|-------|------|-------------|-----------------|
| TC-001 | story-001 | Unit | ... | ... |

## Coverage Checklist
- [ ] All acceptance criteria covered
- [ ] Negative paths identified
- [ ] NFR validations planned
```

### code-mapping.md
```
# Code Mapping — <Unit Name>

| Artifact | Target Path | Notes |
|----------|-------------|-------|
| Entity: Account | submodules/code-output/<repo>/app/Models/Account.php | Generated by <command> |
```
(Link to specific repositories once implementation takes place.)

## Execution Flow
1. Parse the target context’s Units and Stories; confirm the selected Unit matches.
2. Extract key vocabulary (entities, verbs, domain events) to inform the static model.
3. Propose the domain model to the user; incorporate feedback before writing files.
4. Translate approved decisions into ADR(s), capturing trade-offs and alternatives.
5. Design test cases mapped to user stories and NFRs.
6. Update `code-mapping.md` with placeholders for future implementation (mark TODOs clearly if no code exists yet).
7. Summarise outputs and request user confirmation before writing.
8. Use deterministic file write methods (`apply_patch`, `cat <<'EOF' > file`) to persist content.

## Validation Checklist
- No placeholder text like `<TBD>` remains unless user explicitly defers.
- ADR numbering is unique and chronological.
- Sequence diagrams compile (Mermaid syntax valid).
- Tests table covers every acceptance criterion from stories.
- Mention in final summary if additional ADRs or test cases are still pending.

Context: $ARGUMENTS
